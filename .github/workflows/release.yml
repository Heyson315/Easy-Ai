name: Release Management

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.1.0)'
        required: true
        type: string

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for changelog

    - name: Determine version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"

    - name: Generate changelog
      id: changelog
      run: |
        echo "Generating changelog..."
        
        # Get previous tag
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        
        if [ -z "$PREVIOUS_TAG" ]; then
          echo "First release - including all commits"
          COMMIT_RANGE="HEAD"
        else
          echo "Previous tag: $PREVIOUS_TAG"
          COMMIT_RANGE="$PREVIOUS_TAG..HEAD"
        fi
        
        # Generate changelog content
        cat > changelog.md << EOF
        # Release ${{ steps.version.outputs.version }}
        
        **Release Date:** $(date -u +"%Y-%m-%d")
        
        ## ðŸ“‹ What's New
        
        EOF
        
        # Add commit messages grouped by type
        echo "### ðŸš€ Features" >> changelog.md
        git log $COMMIT_RANGE --oneline --grep="feat:" --grep="feature:" | sed 's/^/- /' >> changelog.md || true
        
        echo "" >> changelog.md
        echo "### ðŸ› Bug Fixes" >> changelog.md
        git log $COMMIT_RANGE --oneline --grep="fix:" --grep="bugfix:" | sed 's/^/- /' >> changelog.md || true
        
        echo "" >> changelog.md
        echo "### ðŸ“š Documentation" >> changelog.md
        git log $COMMIT_RANGE --oneline --grep="docs:" | sed 's/^/- /' >> changelog.md || true
        
        echo "" >> changelog.md
        echo "### ðŸ”§ Other Changes" >> changelog.md
        git log $COMMIT_RANGE --oneline --invert-grep --grep="feat:" --grep="fix:" --grep="docs:" | sed 's/^/- /' >> changelog.md || true
        
        # Add metrics
        echo "" >> changelog.md
        echo "## ðŸ“Š Release Metrics" >> changelog.md
        echo "" >> changelog.md
        echo "- **Commits:** $(git rev-list $COMMIT_RANGE --count)" >> changelog.md
        echo "- **Files changed:** $(git diff --name-only $COMMIT_RANGE | wc -l)" >> changelog.md
        echo "- **Contributors:** $(git shortlog -sn $COMMIT_RANGE | wc -l)" >> changelog.md
        
        # Update CHANGELOG.md file
        if [ -f CHANGELOG.md ]; then
          # Backup existing changelog
          cp CHANGELOG.md CHANGELOG.backup.md
          
          # Create new changelog with this release at top
          echo "$(cat changelog.md)" > CHANGELOG.new.md
          echo "" >> CHANGELOG.new.md
          echo "---" >> CHANGELOG.new.md
          echo "" >> CHANGELOG.new.md
          tail -n +2 CHANGELOG.md >> CHANGELOG.new.md
          mv CHANGELOG.new.md CHANGELOG.md
        else
          cp changelog.md CHANGELOG.md
        fi
        
        # Output for next step
        CHANGELOG_CONTENT=$(cat changelog.md)
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Upload changelog
      uses: actions/upload-artifact@v3
      with:
        name: release-changelog
        path: changelog.md

  build-artifacts:
    name: Build Release Artifacts
    runs-on: windows-latest
    needs: prepare-release
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build standalone executables
      run: |
        # Create standalone executables for key scripts
        pyinstaller --onefile --name m365-cis-report scripts/m365_cis_report.py
        pyinstaller --onefile --name clean-csv scripts/clean_csv.py
        pyinstaller --onefile --name security-dashboard scripts/generate_security_dashboard.py

    - name: Package PowerShell module
      shell: powershell
      run: |
        # Create PowerShell module package
        $ModulePath = "M365CIS"
        New-Item -ItemType Directory -Path $ModulePath -Force
        
        Copy-Item "scripts/powershell/modules/M365CIS.psm1" -Destination "$ModulePath/"
        
        # Create module manifest
        $ManifestParams = @{
            Path = "$ModulePath/M365CIS.psd1"
            RootModule = "M365CIS.psm1"
            ModuleVersion = "${{ needs.prepare-release.outputs.version }}".TrimStart('v')
            Author = "Hassan Rahman"
            Description = "Microsoft 365 CIS Security Audit Toolkit"
            PowerShellVersion = "5.1"
            FunctionsToExport = @("*")
            CmdletsToExport = @()
            VariablesToExport = @()
            AliasesToExport = @()
        }
        New-ModuleManifest @ManifestParams
        
        # Create archive
        Compress-Archive -Path $ModulePath -DestinationPath "M365CIS-${{ needs.prepare-release.outputs.version }}.zip"

    - name: Create documentation package
      run: |
        mkdir docs-package
        cp -r docs/* docs-package/ 2>/dev/null || true
        cp README.md docs-package/
        cp CHANGELOG.md docs-package/
        cp IMPLEMENTATION_SUMMARY.md docs-package/
        
        # Create docs archive
        7z a "Documentation-${{ needs.prepare-release.outputs.version }}.zip" docs-package/*

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: release-artifacts
        path: |
          dist/*.exe
          M365CIS-*.zip
          Documentation-*.zip

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare-release, build-artifacts]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download artifacts
      uses: actions/download-artifact@v3
      with:
        name: release-artifacts
        path: release-files/

    - name: Download changelog
      uses: actions/download-artifact@v3
      with:
        name: release-changelog

    - name: Create Release
      uses: actions/create-release@v1
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ needs.prepare-release.outputs.version }}
        release_name: M365 Security Toolkit ${{ needs.prepare-release.outputs.version }}
        body_path: changelog.md
        draft: false
        prerelease: ${{ contains(needs.prepare-release.outputs.version, 'beta') || contains(needs.prepare-release.outputs.version, 'alpha') }}

    - name: Upload Release Assets
      run: |
        # Upload all release files
        for file in release-files/*; do
          if [ -f "$file" ]; then
            echo "Uploading $file..."
            gh release upload ${{ needs.prepare-release.outputs.version }} "$file" --clobber
          fi
        done
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  post-release:
    name: Post-Release Tasks
    runs-on: ubuntu-latest
    needs: [prepare-release, create-release]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Update version in files
      run: |
        # Update version in pyproject.toml if it exists
        if [ -f pyproject.toml ]; then
          sed -i "s/version = \".*\"/version = \"${{ needs.prepare-release.outputs.version }}\"/" pyproject.toml
        fi
        
        # Update version in any Python __init__.py files
        find . -name "__init__.py" -exec sed -i "s/__version__ = \".*\"/__version__ = \"${{ needs.prepare-release.outputs.version }}\"/" {} \;

    - name: Commit version updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "chore: update version to ${{ needs.prepare-release.outputs.version }}" || exit 0
        git push

    - name: Create next development version
      run: |
        # Extract version components
        VERSION="${{ needs.prepare-release.outputs.version }}"
        CLEAN_VERSION=${VERSION#v}
        
        # Increment patch version for next development
        IFS='.' read -ra VERSION_PARTS <<< "$CLEAN_VERSION"
        MAJOR=${VERSION_PARTS[0]}
        MINOR=${VERSION_PARTS[1]}
        PATCH=$((${VERSION_PARTS[2]} + 1))
        
        NEXT_VERSION="v$MAJOR.$MINOR.$PATCH-dev"
        
        echo "Next development version: $NEXT_VERSION"
        
        # Create development branch
        git checkout -b "develop/$NEXT_VERSION"
        git push --set-upstream origin "develop/$NEXT_VERSION"

  notify:
    name: Release Notifications
    runs-on: ubuntu-latest
    needs: [prepare-release, create-release]
    if: always()
    
    steps:
    - name: Success notification
      if: needs.create-release.result == 'success'
      run: |
        echo "ðŸŽ‰ Release ${{ needs.prepare-release.outputs.version }} created successfully!"
        echo "ðŸ“¦ Artifacts have been uploaded to GitHub Releases"
        echo "ðŸ“š Documentation has been updated"
        echo "ðŸ”„ Next development version branch created"

    - name: Failure notification
      if: needs.create-release.result == 'failure'
      run: |
        echo "âŒ Release creation failed!"
        echo "Please check the workflow logs and try again."
        exit 1